@model List<MaterialRequest>
@{
    ViewData["Title"] = "領料單列表";
    var status = ViewBag.Status as string;
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h2>@ViewData["Title"]</h2>
            <a asp-action="Create" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>建立領料單
            </a>
        </div>
    </div>

    <!-- 狀態篩選 -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="btn-group" role="group">
                <a asp-action="Index" class="btn @(string.IsNullOrEmpty(status) ? "btn-primary" : "btn-outline-primary")">
                    全部
                </a>
                <a asp-action="Index" asp-route-status="PENDING" class="btn @(status == "PENDING" ? "btn-warning" : "btn-outline-warning")">
                    待審核
                </a>
                <a asp-action="Index" asp-route-status="APPROVED" class="btn @(status == "APPROVED" ? "btn-success" : "btn-outline-success")">
                    已核准
                </a>
                <a asp-action="Index" asp-route-status="REJECTED" class="btn @(status == "REJECTED" ? "btn-danger" : "btn-outline-danger")">
                    已駁回
                </a>
                <a asp-action="Index" asp-route-status="ISSUED" class="btn @(status == "ISSUED" ? "btn-info" : "btn-outline-info")">
                    已出庫
                </a>
            </div>
        </div>
    </div>

    <!-- 領料單列表 -->
    <div class="card">
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>領料單號</th>
                                <th>申請日期</th>
                                <th>申請人</th>
                                <th>部門</th>
                                <th>狀態</th>
                                <th>項目數</th>
                                <th>審核日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model)
                            {
                                <tr>
                                    <td>
                                        <a asp-action="Details" asp-route-id="@request.Id" class="text-decoration-none">
                                            @request.RequestNo
                                        </a>
                                    </td>
                                    <td>@request.RequestDate.ToString("yyyy-MM-dd")</td>
                                    <td>@(request.Requester?.UserName ?? "")</td>
                                    <td>@request.Department</td>
                                    <td>
                                        @switch (request.Status)
                                        {
                                            case "PENDING":
                                                <span class="badge bg-warning">待審核</span>
                                                break;
                                            case "APPROVED":
                                                <span class="badge bg-success">已核准</span>
                                                break;
                                            case "REJECTED":
                                                <span class="badge bg-danger">已駁回</span>
                                                break;
                                            case "ISSUED":
                                                <span class="badge bg-info">已出庫</span>
                                                break;
                                            default:
                                                <span class="badge bg-secondary">@request.Status</span>
                                                break;
                                        }
                                    </td>
                                    <td>@request.MaterialRequestDetails.Count</td>
                                    <td>@(request.ApprovalDate?.ToString("yyyy-MM-dd") ?? "-")</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a asp-action="Details" asp-route-id="@request.Id" class="btn btn-outline-info">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            @if ((User.IsInRole("SuperAdmin") || User.IsInRole("Manager")) && request.Status == "PENDING")
                                            {
                                                <a asp-action="Approve" asp-route-id="@request.Id" class="btn btn-outline-success">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                            }
                                            @if ((User.IsInRole("SuperAdmin") || User.IsInRole("Manager")) && request.Status == "APPROVED")
                                            {
                                                <button type="button" class="btn btn-outline-primary" onclick="issueRequest(@request.Id)">
                                                    <i class="fas fa-shipping-fast"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted py-4">
                    <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                    <p>尚無領料單記錄</p>
                    <a asp-action="Create" class="btn btn-primary">建立第一個領料單</a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function issueRequest(requestId) {
            if (confirm('確定要執行出庫作業嗎？')) {
                // 創建表單並提交
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '@Url.Action("IssueRequest")';

                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'id';
                input.value = requestId;
                form.appendChild(input);

                var token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    var tokenInput = document.createElement('input');
                    tokenInput.type = 'hidden';
                    tokenInput.name = '__RequestVerificationToken';
                    tokenInput.value = token.value;
                    form.appendChild(tokenInput);
                }

                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
}