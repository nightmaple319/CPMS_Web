@model SparePart
@{
    ViewData["Title"] = "備品詳細資訊";
    var transactionHistory = ViewBag.TransactionHistory as List<InventoryTransaction> ?? new List<InventoryTransaction>();
}

<div class="row">
    <div class="col-md-6">
        <!-- 備品基本資訊 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-info-circle"></i>
                    基本資訊
                </h3>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">編號:</dt>
                    <dd class="col-sm-8">@Model.No</dd>

                    <dt class="col-sm-4">廠區代碼:</dt>
                    <dd class="col-sm-8">@Model.PlantId</dd>

                    <dt class="col-sm-4">位置代碼:</dt>
                    <dd class="col-sm-8">@Model.PositionId</dd>

                    <dt class="col-sm-4">子位置代碼:</dt>
                    <dd class="col-sm-8">@Model.SubPositionId</dd>

                    <dt class="col-sm-4">分類:</dt>
                    <dd class="col-sm-8">@Model.Category</dd>

                    <dt class="col-sm-4">描述:</dt>
                    <dd class="col-sm-8">@Model.Description</dd>

                    <dt class="col-sm-4">規格:</dt>
                    <dd class="col-sm-8">@Model.Specification</dd>

                    <dt class="col-sm-4">庫存數量:</dt>
                    <dd class="col-sm-8">
                        <span class="badge badge-lg @(Model.Quantity == 0 ? "badge-danger" : Model.Quantity <= 5 ? "badge-warning" : "badge-success")">
                            @Model.Quantity
                        </span>
                    </dd>

                    <dt class="col-sm-4">最後更新:</dt>
                    <dd class="col-sm-8">@Model.LastUpdated.ToString("yyyy-MM-dd HH:mm")</dd>

                    <dt class="col-sm-4">備註:</dt>
                    <dd class="col-sm-8">@(string.IsNullOrEmpty(Model.Remarks) ? "-" : Model.Remarks)</dd>
                </dl>
            </div>
            <div class="card-footer">
                <div class="btn-group">
                    @if (User.IsInRole("SuperAdmin") || User.IsInRole("Manager"))
                    {
                        <a asp-action="Edit" asp-route-id="@Model.No" class="btn btn-warning">
                            <i class="fas fa-edit"></i> 編輯
                        </a>
                        <a asp-action="AdjustQuantity" asp-route-id="@Model.No" class="btn btn-info">
                            <i class="fas fa-balance-scale"></i> 調整數量
                        </a>
                    }
                    @if (User.IsInRole("SuperAdmin"))
                    {
                        <a asp-action="Delete" asp-route-id="@Model.No" class="btn btn-danger">
                            <i class="fas fa-trash"></i> 刪除
                        </a>
                    }
                </div>
                <a asp-action="Index" class="btn btn-secondary float-right">
                    <i class="fas fa-arrow-left"></i> 返回列表
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <!-- 庫存狀態卡片 -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    庫存狀態
                </h3>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="description-block border-right">
                            <span class="description-percentage text-@(Model.Quantity == 0 ? "danger" : Model.Quantity <= 5 ? "warning" : "success")">
                                <i class="fas fa-@(Model.Quantity == 0 ? "times" : Model.Quantity <= 5 ? "exclamation-triangle" : "check")"></i>
                            </span>
                            <h5 class="description-header">@Model.Quantity</h5>
                            <span class="description-text">當前庫存</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="description-block border-right">
                            <span class="description-percentage text-green">
                                <i class="fas fa-caret-up"></i>
                            </span>
                            <h5 class="description-header">@transactionHistory.Where(t => t.TransactionType == "IN").Sum(t => t.Quantity)</h5>
                            <span class="description-text">總入庫</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="description-block">
                            <span class="description-percentage text-red">
                                <i class="fas fa-caret-down"></i>
                            </span>
                            <h5 class="description-header">@Math.Abs(transactionHistory.Where(t => t.TransactionType == "OUT").Sum(t => t.Quantity))</h5>
                            <span class="description-text">總出庫</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 異動歷史記錄 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history"></i>
                    異動歷史記錄
                </h3>
            </div>
            <div class="card-body">
                @if (transactionHistory.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>異動日期</th>
                                    <th>異動類型</th>
                                    <th>異動數量</th>
                                    <th>異動前數量</th>
                                    <th>異動後數量</th>
                                    <th>異動原因</th>
                                    <th>異動人員</th>
                                    <th>參考單號</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var transaction in transactionHistory.Take(20))
                                {
                                    <tr>
                                        <td>@transaction.TransactionDate.ToString("MM-dd HH:mm")</td>
                                        <td>
                                            @switch (transaction.TransactionType)
                                            {
                                                case "IN":
                                                    <span class="badge badge-success">入庫</span>
                                                    break;
                                                case "OUT":
                                                    <span class="badge badge-danger">出庫</span>
                                                    break;
                                                case "ADJUST":
                                                    <span class="badge badge-warning">調整</span>
                                                    break;
                                                default:
                                                    <span class="badge badge-secondary">@transaction.TransactionType</span>
                                                    break;
                                            }
                                        </td>
                                        <td class="@(transaction.Quantity > 0 ? "text-success" : "text-danger")">
                                            @(transaction.Quantity > 0 ? "+" : "")@transaction.Quantity
                                        </td>
                                        <td>@transaction.PreviousQuantity</td>
                                        <td>@transaction.NewQuantity</td>
                                        <td>@transaction.Reason</td>
                                        <td>@(transaction.User?.UserName ?? "")</td>
                                        <td>@(string.IsNullOrEmpty(transaction.ReferenceNo) ? "-" : transaction.ReferenceNo)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    @if (transactionHistory.Count > 20)
                    {
                        <div class="text-center mt-3">
                            <small class="text-muted">僅顯示最近 20 筆記錄</small>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>尚無異動記錄</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>